name: "CodeQL Analysis"

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch: {}

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    
    # Evita rodar quando o commit √© apenas a adi√ß√£o do workflow do SonarCloud
    if: ${{ !contains(github.event.head_commit.message, 'Add SonarCloud workflow') }}
    
    permissions:
      security-events: write
      packages: read
      actions: read
      contents: read
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: 'java-kotlin'
            build-mode: 'manual'
            
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # =========================================================================
    # SETUP JAVA (para projetos Java/Kotlin)
    # =========================================================================
    - name: Setup Java for CodeQL
      if: matrix.language == 'java-kotlin' || matrix.language == 'java' || matrix.language == 'kotlin'
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    # =========================================================================
    # INICIALIZA√á√ÉO DO CODEQL
    # =========================================================================
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
    
    # =========================================================================
    # BUILD JAVA/KOTLIN COM DEGRADA√á√ÉO GRACIOSA
    # =========================================================================
    - name: Build Java/Kotlin (Graceful Degradation)
      if: matrix.language == 'java-kotlin' || matrix.language == 'java' || matrix.language == 'kotlin'
      id: java_build
      continue-on-error: true
      run: |
        echo "üîç Iniciando detec√ß√£o de build system..."
        BUILD_SUCCESS="false"
        
        # =====================================================================
        # CORRE√á√ÉO UNIVERSAL: Criar google-services.json falso para Firebase
        # Usando base64 para evitar problemas de escape YAML
        # =====================================================================
        echo "üì± Verificando necessidade de google-services.json..."
        
        if grep -rq "com.google.gms.google-services" . 2>/dev/null || grep -rq "google-services" . 2>/dev/null; then
          echo "üî• Projeto usa Firebase/Google Services"
          
          for app_dir in $(find . -type d -name "app"); do
            if [ ! -f "$app_dir/google-services.json" ]; then
              echo "üìù Criando google-services.json dummy em: $app_dir"
              echo "ewogICJwcm9qZWN0X2luZm8iOiB7CiAgICAicHJvamVjdF9udW1iZXIiOiAiMDAwMDAwMDAwMDAwIiwKICAgICJwcm9qZWN0X2lkIjogImR1bW15LXByb2plY3QtZm9yLWNpIiwKICAgICJzdG9yYWdlX2J1Y2tldCI6ICJkdW1teS1wcm9qZWN0LWZvci1jaS5hcHBzcG90LmNvbSIKICB9LAogICJjbGllbnQiOiBbCiAgICB7CiAgICAgICJjbGllbnRfaW5mbyI6IHsKICAgICAgICAibW9iaWxlc2RrX2FwcF9pZCI6ICIxOjAwMDAwMDAwMDAwMDphbmRyb2lkOjAwMDAwMDAwMDAwMDAwMDAwMDAwMDAiLAogICAgICAgICJhbmRyb2lkX2NsaWVudF9pbmZvIjogewogICAgICAgICAgInBhY2thZ2VfbmFtZSI6ICJjb20uZXhhbXBsZS5hcHAiCiAgICAgICAgfQogICAgICB9LAogICAgICAiYXBpX2tleSI6IFsKICAgICAgICB7CiAgICAgICAgICAiY3VycmVudF9rZXkiOiAiQUl6YVN5RHVtbXlLZXlGb3JDSUJ1aWxkT25seTAwMDAwMDAwMCIKICAgICAgICB9CiAgICAgIF0KICAgIH0KICBdLAogICJjb25maWd1cmF0aW9uX3ZlcnNpb24iOiAiMSIKfQo=" | base64 -d > "$app_dir/google-services.json"
            fi
          done
        fi
        
        # =====================================================================
        # 1. MAVEN
        # =====================================================================
        POM_PATH=$(find . -maxdepth 3 -name "pom.xml" -type f | head -n 1)
        if [ -n "$POM_PATH" ]; then
          echo "‚úÖ Maven Project encontrado em: $POM_PATH"
          if mvn clean compile -DskipTests -Dmaven.test.skip=true -f "$POM_PATH" --batch-mode; then
             echo "‚úÖ Build Maven conclu√≠do com sucesso."
             BUILD_SUCCESS="true"
          else
             echo "‚ö†Ô∏è Build Maven falhou."
          fi
          echo "build_success=$BUILD_SUCCESS" >> $GITHUB_OUTPUT
          exit 0
        fi

        # =====================================================================
        # 2. GRADLE (com detec√ß√£o din√¢mica de vers√£o)
        # =====================================================================
        GRADLE_FILE=$(find . -maxdepth 3 \( -name "build.gradle" -o -name "build.gradle.kts" \) -type f | head -n 1)

        if [ -n "$GRADLE_FILE" ]; then
           echo "‚úÖ Gradle File encontrado em: $GRADLE_FILE"
           BUILD_DIR=$(dirname "$GRADLE_FILE")
           
           PROPS=$(find . -name "gradle-wrapper.properties" -type f | head -n 1)
           TARGET_VER="8.10.2"
           
           if [ -f "$PROPS" ]; then
             echo "üìÑ Properties encontrado: $PROPS"
             ver=$(grep -oE 'gradle-[0-9.]+(-(bin|all))?\.zip' "$PROPS" | grep -oE '[0-9]+\.[0-9]+(\.[0-9]+)?' | head -n 1)
             if [ -n "$ver" ]; then 
               TARGET_VER="$ver"
               echo "‚úÖ Vers√£o detectada no projeto: $TARGET_VER"
             else
               echo "‚ö†Ô∏è N√£o foi poss√≠vel extrair vers√£o, usando fallback: $TARGET_VER"
             fi
           else
             echo "‚ö†Ô∏è gradle-wrapper.properties n√£o encontrado, usando fallback: $TARGET_VER"
           fi
           
           echo "‚¨áÔ∏è Baixando Gradle $TARGET_VER..."
           wget -q "https://services.gradle.org/distributions/gradle-${TARGET_VER}-bin.zip" || {
             echo "‚ùå Falha ao baixar Gradle $TARGET_VER"
             echo "build_success=false" >> $GITHUB_OUTPUT
             exit 0
           }
           unzip -q "gradle-${TARGET_VER}-bin.zip"
           export PATH="$PWD/gradle-${TARGET_VER}/bin:$PATH"
           echo "‚úÖ Gradle $TARGET_VER instalado"
           
           cd "$BUILD_DIR"
           
           echo "üöÄ Tentando compilar..."
           
           if gradle compileDebugSources -x test -x lint --no-daemon 2>/dev/null; then
              echo "‚úÖ Build (compileDebugSources) conclu√≠do com sucesso."
              BUILD_SUCCESS="true"
           elif gradle compileKotlin -x test --no-daemon 2>/dev/null; then
              echo "‚úÖ Build (compileKotlin) conclu√≠do com sucesso."
              BUILD_SUCCESS="true"
           elif gradle compileJava -x test --no-daemon 2>/dev/null; then
              echo "‚úÖ Build (compileJava) conclu√≠do com sucesso."
              BUILD_SUCCESS="true"
           elif gradle classes -x test --no-daemon 2>/dev/null; then
              echo "‚úÖ Build (classes) conclu√≠do com sucesso."
              BUILD_SUCCESS="true"
           else
              echo "‚ö†Ô∏è Todas as estrat√©gias de build falharam."
           fi
           
           echo "build_success=$BUILD_SUCCESS" >> $GITHUB_OUTPUT
           exit 0
        fi

        echo "‚ö†Ô∏è Nenhum build system Java reconhecido. CodeQL far√° an√°lise source-only."
        echo "build_success=true" >> $GITHUB_OUTPUT
        exit 0

    # =========================================================================
    # VERIFICA√á√ÉO DO RESULTADO DO BUILD
    # =========================================================================
    - name: Check Build Result
      if: matrix.language == 'java-kotlin' || matrix.language == 'java' || matrix.language == 'kotlin'
      id: build_check
      run: |
        if [ "${{ steps.java_build.outputs.build_success }}" == "true" ]; then
          echo "‚úÖ Build bem-sucedido. CodeQL Analysis ser√° executada."
          echo "should_analyze=true" >> $GITHUB_OUTPUT
        else
          echo "‚ö†Ô∏è Build falhou ou n√£o foi poss√≠vel compilar."
          echo "‚ö†Ô∏è CodeQL Analysis ser√° PULADA para este projeto."
          echo "should_analyze=false" >> $GITHUB_OUTPUT
        fi

    # =========================================================================
    # BUILD C/C++
    # =========================================================================
    - name: Build CPP
      if: matrix.language == 'cpp' && matrix.build-mode == 'manual'
      continue-on-error: true
      run: |
        sudo apt-get update && sudo apt-get install -y build-essential
        if [ -f "Makefile" ] || [ -f "CMakeLists.txt" ]; then
           make -k || (cmake . && make -k) || true
        fi
        find . -name "*.cpp" -print0 | xargs -0 -I {} bash -c 'g++ -c "{}" || true'
        find . -name "*.c" -print0 | xargs -0 -I {} bash -c 'gcc -c "{}" || true'

    # =========================================================================
    # AUTOBUILD (para linguagens que n√£o s√£o Java/Kotlin/C++)
    # =========================================================================
    - name: Autobuild (Non-Java/CPP)
      if: matrix.language != 'java-kotlin' && matrix.language != 'java' && matrix.language != 'kotlin' && matrix.language != 'cpp'
      uses: github/codeql-action/autobuild@v3
    
    # =========================================================================
    # AN√ÅLISE CODEQL (CONDICIONAL)
    # =========================================================================
    - name: Perform CodeQL Analysis
      if: |
        always() && 
        (
          (matrix.language != 'java-kotlin' && matrix.language != 'java' && matrix.language != 'kotlin') ||
          (steps.build_check.outputs.should_analyze == 'true')
        )
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{ matrix.language }}"
    
    # =========================================================================
    # MENSAGEM FINAL (quando an√°lise foi pulada)
    # =========================================================================
    - name: Report Skipped Analysis
      if: |
        always() && 
        (matrix.language == 'java-kotlin' || matrix.language == 'java' || matrix.language == 'kotlin') &&
        steps.build_check.outputs.should_analyze == 'false'
      run: |
        echo "============================================================"
        echo "‚ö†Ô∏è  AN√ÅLISE CODEQL PULADA"
        echo "============================================================"
        echo ""
        echo "O build do projeto falhou, impossibilitando a an√°lise do CodeQL."
        echo "Isso geralmente ocorre por:"
        echo "  - Depend√™ncias externas n√£o dispon√≠veis (JitPack, Maven, etc.)"
        echo "  - Configura√ß√µes ausentes (google-services.json, etc.)"
        echo "  - Erros de compila√ß√£o no c√≥digo fonte"
        echo ""
        echo "A an√°lise do SonarCloud ainda pode ter sido executada com sucesso,"
        echo "fornecendo m√©tricas de qualidade de c√≥digo."
        echo "============================================================"